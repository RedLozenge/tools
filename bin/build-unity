#!/bin/bash

BASE_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )"/../.. && pwd )"
BUILD_LOG="build.log"
VERBOSE=""

pushd "${BASE_PATH}" &> /dev/null

tools/bin/ensure-unity-is-closed
if [ $? -ne 0 ]; then
    echo "error: unity is still running, aborting build."
    exit 1
fi

if [ "$1"=="-v" ]; then
    VERBOSE="true"
fi

# Remove old build log
rm "${BUILD_LOG}" &> /dev/null || true

# Execute Unity build
echo "building Xcode project from Unity..."
/Applications/Unity/Unity.app/Contents/MacOS/Unity \
    -batchmode \
    -quit \
    -logFile "${BUILD_LOG}" \
    -projectPath "${BASE_PATH}/" \
    -executeMethod BuildScript.PerformBuild

# Check to see if iOS built properly... in a gross way, since Unity doesn't
# believe in error codes.
grep "Completed 'Build.Player.iPhonePlayer'" "${BUILD_LOG}" &> /dev/null
UNITY_BUILD_STATUS=$?

# Check build status
if [ $UNITY_BUILD_STATUS -ne 0 ]; then
    # Check to see if the build failed because don't have UnityPro, give notice
    # and exit
    grep "requires Unity PRO" "${BUILD_LOG}" &> /dev/null
    if [ $? -eq 0 ]; then
        echo "warning: cannot build from the command line because you aren't using Unity Pro."
        echo "         continuing anyway."
        exit 0
    fi

    echo "error: build failed, see log file '${BUILD_LOG}'"
    if [ ! -z "${VERBOSE}" ]; then
        cat "${BUILD_LOG}"
    fi
    exit 1
else
    echo "build succeeded"
    exit 0
fi
